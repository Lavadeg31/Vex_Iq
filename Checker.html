<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>VEX IQ Rapid Relay Score Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f5f5dc;
      color: #1a1a1a;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1, h2 {
      text-align: center;
      color: #1a1a1a;
      margin-bottom: 20px;
    }

    table {
      width: 80%;
      margin-top: 20px;
      color: #1a1a1a;
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid #1a1a1a;
      padding: 10px;
      text-align: center;
    }

    .statistics {
      margin-top: 30px;
      background-color: #d2c2a3;
      color: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      width: 80%;
    }

    .statistics p {
      margin: 10px 0;
      font-size: 18px;
    }

    #uploadButton {
      width: 150px;
      padding: 10px;
      background-color: #d2c2a3;
      color: #1a1a1a;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      margin: 20px auto;
      display: block;
    }

    #uploadButton:hover {
      background-color: #bfae90;
    }

  .chart-container {
    width: 100%; /* Ensures full width scaling */
    max-width: 1200px; /* Max width for larger screens */
    margin: 20px auto;
    padding: 20px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    width: 100%; /* Ensures full width scaling */
    max-width: 80vw; /* Responsive layout */
    margin: 20px auto;
  }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <h1>Enhanced VEX IQ Rapid Relay Score Viewer</h1>
  <button id="uploadButton" onclick="document.getElementById('fileInput').click();">Upload Scores</button>
  <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileUpload()">

  <div class="statistics" id="statistics">
    <h2>Performance Analytics</h2>
    <div id="basicStats"></div>
    <div id="advancedStats"></div>
  </div>

  <div class="chart-grid">
    <div class="chart-container">
      <canvas id="scoreOverTime"></canvas>
    </div>
    <div class="chart-container">
  <canvas id="scoreGrowthRate"></canvas>
</div>
<div class="chart-container">
  <canvas id="scoreDeviationOverTime"></canvas>
</div>
    <div class="chart-container">
      <canvas id="movingAverages"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="scoreDistribution"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="performanceConsistency"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    function handleFileUpload() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          try {
            const scores = JSON.parse(decodeURIComponent(escape(atob(event.target.result.replace(/^data:text\/plain;base64,/, '')))));
            if (!Array.isArray(scores)) throw new Error('Invalid JSON structure');
            processAndDisplayData(scores);
          } catch (e) {
            alert('Invalid file format. Please upload a valid scores JSON file.');
          }
        };
        reader.readAsText(file);
      }
    }

    function calculateStatistics(scores) {
      const stats = {
        total: scores.length,
        mean: scores.reduce((a, b) => a + b, 0) / scores.length,
        best: Math.max(...scores),
        worst: Math.min(...scores),
        recent6Avg: scores.slice(-6).reduce((a, b) => a + b, 0) / Math.min(6, scores.length),
        recent12Avg: scores.slice(-12).reduce((a, b) => a + b, 0) / Math.min(12, scores.length)
      };

      // Calculate standard deviation
      const variance = scores.reduce((a, b) => a + Math.pow(b - stats.mean, 2), 0) / scores.length;
      stats.stdDev = Math.sqrt(variance);

      // Calculate consistency score (inverse of coefficient of variation)
      stats.consistency = (1 - (stats.stdDev / stats.mean)) * 100;

      return stats;
    }

    function calculateMovingAverage(scores, window) {
      return scores.map((_, idx) => {
        const start = Math.max(0, idx - window + 1);
        const windowScores = scores.slice(start, idx + 1);
        return windowScores.reduce((a, b) => a + b, 0) / windowScores.length;
      });
    }

    function createScoreOverTimeChart(scores) {
      const ctx = document.getElementById('scoreOverTime').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: scores.map((_, i) => `Attempt ${i + 1}`),
          datasets: [{
            label: 'Score',
            data: scores,
            borderColor: '#1a1a1a',
            backgroundColor: 'rgba(26, 26, 26, 0.1)',
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Score Progression'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Score'
              }
            }
          }
        }
      });
    }

    function createMovingAveragesChart(scores) {
      const ma3 = calculateMovingAverage(scores, 3);
      const ma6 = calculateMovingAverage(scores, 6);
      
      const ctx = document.getElementById('movingAverages').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: scores.map((_, i) => `Attempt ${i + 1}`),
          datasets: [{
            label: '3-Attempt MA',
            data: ma3,
            borderColor: '#d4af37',
            borderWidth: 2,
            fill: false
          }, {
            label: '6-Attempt MA',
            data: ma6,
            borderColor: '#1a1a1a',
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Moving Averages Trend'
            }
          }
        }
      });
    }

    function createScoreDistributionChart(scores) {
      const binSize = 5;
      const bins = {};
      scores.forEach(score => {
        const bin = Math.floor(score / binSize) * binSize;
        bins[bin] = (bins[bin] || 0) + 1;
      });

      const ctx = document.getElementById('scoreDistribution').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(bins),
          datasets: [{
            label: 'Frequency',
            data: Object.values(bins),
            backgroundColor: '#d2c2a3',
            borderColor: '#1a1a1a',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Score Distribution'
            }
          }
        }
      });
    }

    function createPerformanceConsistencyChart(scores) {
      const stats = calculateStatistics(scores);
      const consistency = scores.map(score => 
        Math.abs(score - stats.mean) <= stats.stdDev ? 'Within 1σ' :
        Math.abs(score - stats.mean) <= 2 * stats.stdDev ? 'Within 2σ' : 'Outside 2σ'
      );

      const distribution = {
        'Within 1σ': consistency.filter(x => x === 'Within 1σ').length,
        'Within 2σ': consistency.filter(x => x === 'Within 2σ').length,
        'Outside 2σ': consistency.filter(x => x === 'Outside 2σ').length
      };

      const ctx = document.getElementById('performanceConsistency').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(distribution),
          datasets: [{
            data: Object.values(distribution),
            backgroundColor: ['#d4af37', '#d2c2a3', '#1a1a1a']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Performance Consistency'
            }
          }
        }
      });
    }

    function updateStatistics(stats) {
      const basicStats = document.getElementById('basicStats');
      basicStats.innerHTML = `
        <p>Total Attempts: ${stats.total}</p>
        <p>Average Score: ${stats.mean.toFixed(2)}</p>
        <p>Best Score: ${stats.best}</p>
        <p>Worst Score: ${stats.worst}</p>
        <p>Recent 6 Average: ${stats.recent6Avg.toFixed(2)}</p>
        <p>Recent 12 Average: ${stats.recent12Avg.toFixed(2)}</p>
        <p>Consistency Score: ${stats.consistency.toFixed(1)}%</p>
      `;
    }

function processAndDisplayData(scores) {
  const stats = calculateStatistics(scores);
  updateStatistics(stats);

  createScoreOverTimeChart(scores);
  createMovingAveragesChart(scores);
  createScoreDistributionChart(scores);
  createPerformanceConsistencyChart(scores);
  createScoreGrowthRateChart(scores);          // New chart
  createScoreDeviationOverTimeChart(scores);    // New chart
}

    function createScoreGrowthRateChart(scores) {
  const growthRates = scores.slice(1).map((score, i) => score - scores[i]);

  const ctx = document.getElementById('scoreGrowthRate').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: growthRates.map((_, i) => `Attempt ${i + 2}`),
      datasets: [{
        label: 'Score Growth Rate',
        data: growthRates,
        borderColor: '#007ACC',
        backgroundColor: 'rgba(0, 122, 204, 0.1)',
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Score Growth Rate Over Time'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Growth Rate'
          }
        }
      }
    }
  });
}

function createScoreDeviationOverTimeChart(scores) {
  const stats = calculateStatistics(scores);
  const deviations = scores.map(score => score - stats.mean);

  const ctx = document.getElementById('scoreDeviationOverTime').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: deviations.map((_, i) => `Attempt ${i + 1}`),
      datasets: [{
        label: 'Score Deviation from Mean',
        data: deviations,
        borderColor: '#FF6347',
        backgroundColor: 'rgba(255, 99, 71, 0.1)',
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Score Deviation from Mean Over Time'
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          title: {
            display: true,
            text: 'Deviation from Mean'
          }
        }
      }
    }
  });
}
  </script>
</body>
</html>
